<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>40-Day Habit Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .bounce-in { animation: bounceIn 0.6s ease-out; }
        @keyframes bounceIn { 0% { transform: scale(0.3); opacity: 0; } 50% { transform: scale(1.05); } 70% { transform: scale(0.9); } 100% { transform: scale(1); opacity: 1; } }
        .celebration { animation: celebration 1s ease-out; }
        @keyframes celebration { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .blur-overlay { backdrop-filter: blur(4px); }
        .pulse-saving { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .section-header { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="app" class="min-h-screen gradient-bg">
        <!-- Loading Screen -->
        <div id="loading" class="min-h-screen flex items-center justify-center">
            <div class="bg-white rounded-lg p-8 text-center">
                <div class="animate-spin w-8 h-8 border-4 border-purple-500 border-t-transparent rounded-full mx-auto mb-4"></div>
                <p class="text-gray-600">Building your personalized habit tracker...</p>
            </div>
        </div>
        
        <!-- Main App (hidden initially) -->
        <div id="main-app" style="display: none;">
            <!-- Demo Banner -->
            <div id="demo-banner" class="bg-amber-100 border-b border-amber-200 px-4 py-2 text-center">
                <span class="text-amber-800 text-sm font-medium">
                    🌟 Demo Mode - Create an account for full personalization and progress tracking!
                </span>
            </div>

            <!-- Header -->
            <div class="bg-white shadow-lg">
                <div class="max-w-6xl mx-auto px-6 py-4">
                    <div class="flex justify-between items-center">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                                <span class="text-white font-bold">H</span>
                            </div>
                            <h1 class="text-2xl font-bold text-gray-800">40-Day Habit Tracker</h1>
                            <span id="user-welcome" class="text-sm text-gray-600" style="display: none;"></span>
                        </div>
                        
                        <div class="flex items-center space-x-2">
                            <!-- Auth Buttons (shown when not logged in) -->
                            <div id="auth-buttons">
                                <button onclick="showAuthModal('login')" class="px-5 py-2.5 text-purple-600 hover:bg-purple-50 rounded-lg transition-all duration-200 font-medium border border-purple-200 hover:border-purple-300">Login</button>
                                <button onclick="showAuthModal('register')" class="px-5 py-2.5 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-200 font-medium shadow-lg transform hover:scale-105">Register</button>
                            </div>
                            
                            <!-- User Buttons (shown when logged in) -->
                            <div id="user-buttons" style="display: none;">
                                <button onclick="toggleDataManagement()" class="px-4 py-2.5 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all duration-200 text-sm font-medium shadow-lg">
                                    <span class="flex items-center space-x-1">
                                        <span>📁</span>
                                        <span>Data Management</span>
                                    </span>
                                </button>
                                <button onclick="toggleEditMode()" id="edit-btn" class="px-4 py-2.5 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-all duration-200 text-sm font-medium shadow-sm">
                                    ⚙️ Edit Activities
                                </button>
                                <button onclick="logout()" class="px-4 py-2.5 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-all duration-200 text-sm font-medium shadow-sm">
                                    🚪 Logout
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="max-w-6xl mx-auto p-6">
                <!-- Stats Overview -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Overall Progress</p>
                                <p id="overall-progress" class="text-3xl font-bold text-purple-600">0%</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">📊</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Current Day</p>
                                <p id="current-day-stat" class="text-3xl font-bold text-blue-600">1/40</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">📅</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6 card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Perfect Days</p>
                                <p id="perfect-days" class="text-3xl font-bold text-green-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <span class="text-2xl">🏆</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Edit Mode Panel -->
                <div id="edit-panel" class="bg-white rounded-xl shadow-lg mb-8" style="display: none;">
                    <div class="p-6 border-b border-gray-200">
                        <h2 class="text-xl font-bold text-gray-800">Manage Activities</h2>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-0 min-h-[400px]">
                        <!-- Left Panel -->
                        <div class="lg:col-span-2 bg-gray-50 p-6 border-r border-gray-200">
                            <div class="space-y-6">
                                <!-- Add New Activity -->
                                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                    <h3 class="font-semibold text-gray-800 mb-4">Add New Activity</h3>
                                    <div class="space-y-3">
                                        <select id="new-icon" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option value="✨">✨ Sparkles</option>
                                            <option value="🏃‍♂️">🏃‍♂️ Exercise</option>
                                            <option value="📚">📚 Reading</option>
                                            <option value="🧘‍♀️">🧘‍♀️ Meditation</option>
                                            <option value="💧">💧 Water</option>
                                            <option value="✍️">✍️ Writing</option>
                                            <option value="🍎">🍎 Healthy Food</option>
                                            <option value="💪">💪 Strength</option>
                                            <option value="☀️">☀️ Sun</option>
                                            <option value="🌙">🌙 Moon</option>
                                        </select>
                                        <select id="new-time" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                            <option value="morning">🌅 Morning</option>
                                            <option value="midday">☀️ Mid-day</option>
                                            <option value="evening">🌙 Evening</option>
                                        </select>
                                        <input id="new-name" type="text" placeholder="Activity name..." class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                        <button onclick="addActivity()" class="w-full py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium">
                                            ➕ Add Activity
                                        </button>
                                    </div>
                                </div>

                                <!-- Quick Stats -->
                                <div class="bg-white rounded-lg p-4 shadow-sm border border-gray-200">
                                    <h3 class="font-semibold text-gray-800 mb-3">Activity Stats</h3>
                                    <div id="activity-stats" class="space-y-2 text-sm"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Right Panel -->
                        <div class="lg:col-span-3 p-6">
                            <h3 class="font-semibold text-gray-800 mb-4">Your Activities</h3>
                            <div id="edit-activities-list"></div>
                        </div>
                    </div>
                </div>

                <!-- Day Selector -->
                <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">40-Day Journey</h2>
                    <div id="day-grid" class="grid grid-cols-8 gap-2 mb-4"></div>
                    <div class="flex items-center gap-4 text-sm text-gray-600">
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-gray-100 rounded"></div>
                            <span>Not Started</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-yellow-400 rounded"></div>
                            <span>In Progress</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="w-4 h-4 bg-green-500 rounded"></div>
                            <span>Complete</span>
                        </div>
                    </div>
                </div>

                <!-- Daily Activities -->
                <div class="bg-white rounded-xl shadow-lg p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h2 id="day-title" class="text-2xl font-bold text-gray-800">Day 1 Activities</h2>
                        <div id="day-progress" class="text-sm text-gray-600">0 / 0 completed</div>
                    </div>
                    
                    <div id="activities-container"></div>
                    
                    <!-- Completion Celebration -->
                    <div id="celebration" class="mt-6 text-center p-4 bg-gradient-to-r from-green-400 to-blue-500 rounded-xl text-white celebration" style="display: none;">
                        <div class="text-4xl mb-2">🎉</div>
                        <h3 class="text-xl font-bold">Day Complete!</h3>
                        <p>You're building amazing habits!</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Auth Modal -->
        <div id="auth-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 p-4 backdrop-blur-sm" style="display: none;">
            <div class="bg-white rounded-2xl p-8 w-full max-w-md shadow-2xl fade-in">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center">
                            <span class="text-white font-bold">H</span>
                        </div>
                        <h2 id="auth-title" class="text-2xl font-bold text-gray-800">Welcome!</h2>
                    </div>
                    <button onclick="closeAuthModal()" class="text-gray-400 hover:text-gray-600 text-2xl transition-colors">×</button>
                </div>
                
                <form id="auth-form" class="space-y-5">
                    <div id="name-field" style="display: none;">
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Full Name</label>
                        <input id="auth-name" type="text" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Email Address</label>
                        <input id="auth-email" type="email" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Password</label>
                        <input id="auth-password" type="password" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all" required>
                    </div>
                    <button type="submit" id="auth-submit" class="w-full py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-200 font-semibold shadow-lg transform hover:scale-105">
                        Login
                    </button>
                </form>
                
                <div class="mt-6 text-center">
                    <button id="auth-switch" onclick="switchAuthMode()" class="text-purple-600 hover:text-purple-700 text-sm font-medium transition-colors">
                        Don't have an account? Register here
                    </button>
                </div>
            </div>
        </div>

        <!-- Demo Message -->
        <div id="demo-message" class="fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-8 shadow-2xl z-50 border-2 border-purple-200 max-w-sm w-full mx-4 fade-in" style="display: none;">
            <div class="text-center">
                <div class="w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-2xl text-white">🔒</span>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-3">Account Required</h3>
                <p class="text-gray-600 mb-6 leading-relaxed">Having an account will provide a much more customized experience with progress tracking and data sync!</p>
                <div class="flex space-x-3">
                    <button onclick="showAuthModal('register')" class="flex-1 px-4 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:from-purple-700 hover:to-purple-800 transition-all duration-200 font-medium shadow-lg">
                        Register
                    </button>
                    <button onclick="showAuthModal('login')" class="flex-1 px-4 py-3 text-purple-600 border-2 border-purple-300 rounded-lg hover:bg-purple-50 transition-all duration-200 font-medium">
                        Login
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Management Panel -->
        <div id="data-panel" class="fixed right-4 top-20 w-80 bg-white rounded-xl shadow-2xl border border-gray-200 z-40 p-6 fade-in" style="display: none;">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center space-x-2">
                    <div class="w-8 h-8 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
                        <span class="text-white text-sm font-bold">📁</span>
                    </div>
                    <h3 class="font-bold text-gray-800">Data Management</h3>
                </div>
                <button onclick="toggleDataManagement()" class="text-gray-400 hover:text-gray-600 transition-colors text-xl">×</button>
            </div>
            
            <div class="space-y-6">
                <div class="bg-gray-50 rounded-lg p-4">
                    <label class="flex items-center space-x-3 mb-3 cursor-pointer">
                        <input type="radio" name="dataMode" value="local" checked onchange="setDataMode('local')" class="text-purple-600">
                        <div>
                            <span class="font-semibold text-gray-800">Keep Data Local</span>
                            <p class="text-xs text-gray-600">Store on your device with backup options</p>
                        </div>
                    </label>
                    <div id="local-options" class="space-y-2">
                        <button onclick="exportData()" class="w-full text-left px-4 py-3 bg-green-50 text-green-700 rounded-lg hover:bg-green-100 transition-all duration-200 text-sm font-medium border border-green-200 hover:border-green-300">
                            <div class="flex items-center space-x-2">
                                <span>📥</span>
                                <span>Export Data</span>
                            </div>
                            <div class="text-xs text-green-600 mt-1">Download backup file</div>
                        </button>
                        <label class="block w-full text-left px-4 py-3 bg-purple-50 text-purple-700 rounded-lg hover:bg-purple-100 transition-all duration-200 text-sm font-medium cursor-pointer border border-purple-200 hover:border-purple-300">
                            <div class="flex items-center space-x-2">
                                <span>📤</span>
                                <span>Import Data</span>
                            </div>
                            <div class="text-xs text-purple-600 mt-1">Restore from backup file</div>
                            <input type="file" accept=".json" onchange="importData(event)" class="hidden">
                        </label>
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-4">
                    <label class="flex items-center space-x-3 mb-3 cursor-pointer">
                        <input type="radio" name="dataMode" value="cloud" onchange="setDataMode('cloud')" class="text-purple-600">
                        <div>
                            <span class="font-semibold text-gray-800">Keep Data on Cloud</span>
                            <p class="text-xs text-gray-600">Sync across devices via Supabase</p>
                        </div>
                    </label>
                    <div id="cloud-options" class="space-y-3" style="display: none;">
                        <div id="cloud-status" class="text-xs text-gray-500 bg-blue-50 p-2 rounded border-l-4 border-blue-400" style="display: none;">
                            <span id="cloud-status-text">🔗 Connected to Supabase</span>
                        </div>
                        <div id="cloud-form">
                            <div class="space-y-2">
                                <input id="cloud-url" type="url" placeholder="https://your-project.supabase.co" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                                <input id="cloud-key" type="password" placeholder="eyJhbGci... (anon key)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                                <input id="cloud-user" type="text" placeholder="Your User ID (e.g., john@email.com)" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
                            </div>
                            <button id="connect-btn" onclick="connectCloud()" class="w-full py-3 bg-gradient-to-r from-green-600 to-green-700 text-white rounded-lg hover:from-green-700 hover:to-green-800 transition-all duration-200 text-sm font-semibold shadow-lg mt-3">
                                Connect to Cloud
                            </button>
                        </div>
                        <div class="text-xs text-gray-500 bg-amber-50 p-2 rounded border-l-4 border-amber-400">
                            <strong>📋 Setup Required:</strong> Create these tables in your Supabase SQL Editor first:
                            <button onclick="copySupabaseSQL()" class="ml-2 text-amber-600 hover:text-amber-800 underline">Copy SQL</button>
                        </div>
                        <button id="disconnect-btn" onclick="disconnectCloud()" class="w-full py-2 bg-red-100 text-red-700 rounded-lg hover:bg-red-200 transition-colors text-sm font-medium" style="display: none;">
                            Disconnect from Cloud
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentDay = 1;
        let isAuthenticated = false;
        let currentUser = null;
        let editMode = false;
        let authMode = 'login';
        let users = [];
        let progress = {};
        let collapsedSections = {};
        let editingActivity = null;
        let supabase = null;
        let isCloudConnected = false;
        let cloudUserId = null;
        
        let activities = [
            { id: 1, name: 'Morning Exercise', icon: '🏃‍♂️', timeOfDay: 'morning' },
            { id: 2, name: 'Healthy Breakfast', icon: '🍎', timeOfDay: 'morning' },
            { id: 3, name: 'Read 30 Minutes', icon: '📚', timeOfDay: 'midday' },
            { id: 4, name: 'Drink Water', icon: '💧', timeOfDay: 'midday' },
            { id: 5, name: 'Meditate', icon: '🧘‍♀️', timeOfDay: 'evening' },
            { id: 6, name: 'Journal', icon: '✍️', timeOfDay: 'evening' }
        ];

        const timeOptions = [
            { value: 'morning', label: 'Morning', icon: '🌅' },
            { value: 'midday', label: 'Mid-day', icon: '☀️' },
            { value: 'evening', label: 'Evening', icon: '🌙' }
        ];

        // Initialize app
        setTimeout(() => {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            renderAll();
        }, 1000);

        // Authentication functions
        function showAuthModal(mode) {
            authMode = mode;
            document.getElementById('auth-modal').style.display = 'flex';
            document.getElementById('auth-title').textContent = mode === 'login' ? 'Welcome Back!' : 'Create Account';
            document.getElementById('name-field').style.display = mode === 'register' ? 'block' : 'none';
            document.getElementById('auth-submit').textContent = mode === 'login' ? 'Login' : 'Create Account';
            document.getElementById('auth-switch').textContent = mode === 'login' 
                ? "Don't have an account? Register here" 
                : "Already have an account? Login here";
        }

        function closeAuthModal() {
            document.getElementById('auth-modal').style.display = 'none';
            document.getElementById('auth-form').reset();
        }

        function switchAuthMode() {
            showAuthModal(authMode === 'login' ? 'register' : 'login');
        }

        document.getElementById('auth-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;

            if (authMode === 'register') {
                const newUser = {
                    id: Date.now(),
                    email,
                    name: name || email,
                    activities: [...activities],
                    progress: {},
                    currentDay: 1
                };
                users.push(newUser);
                currentUser = newUser;
                isAuthenticated = true;
            } else {
                const user = users.find(u => u.email === email);
                if (user) {
                    currentUser = user;
                    activities = user.activities;
                    progress = user.progress;
                    currentDay = user.currentDay;
                    isAuthenticated = true;
                } else {
                    alert('User not found. Please register first.');
                    return;
                }
            }
            
            closeAuthModal();
            renderAll();
        });

        function logout() {
            isAuthenticated = false;
            currentUser = null;
            progress = {};
            currentDay = 1;
            activities = [
                { id: 1, name: 'Morning Exercise', icon: '🏃‍♂️', timeOfDay: 'morning' },
                { id: 2, name: 'Healthy Breakfast', icon: '🍎', timeOfDay: 'morning' },
                { id: 3, name: 'Read 30 Minutes', icon: '📚', timeOfDay: 'midday' },
                { id: 4, name: 'Drink Water', icon: '💧', timeOfDay: 'midday' },
                { id: 5, name: 'Meditate', icon: '🧘‍♀️', timeOfDay: 'evening' },
                { id: 6, name: 'Journal', icon: '✍️', timeOfDay: 'evening' }
            ];
            editMode = false;
            renderAll();
        }

        function requireAuth() {
            if (!isAuthenticated) {
                document.getElementById('demo-message').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('demo-message').style.display = 'none';
                }, 3000);
                return false;
            }
            return true;
        }

        // Activity functions
        function isCompleted(day, activityId) {
            return progress[day] && progress[day][activityId] || false;
        }

        function toggleActivity(day, activityId) {
            if (!requireAuth()) return;
            
            if (!progress[day]) progress[day] = {};
            progress[day][activityId] = !progress[day][activityId];
            autoSaveToCloud();
            renderAll();
        }

        function getCurrentStreak(activityId) {
            let streak = 0;
            for (let day = currentDay; day >= 1; day--) {
                if (isCompleted(day, activityId)) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        function getLongestStreak(activityId) {
            let maxStreak = 0;
            let currentStreak = 0;
            
            for (let day = 1; day <= 40; day++) {
                if (isCompleted(day, activityId)) {
                    currentStreak++;
                    maxStreak = Math.max(maxStreak, currentStreak);
                } else {
                    currentStreak = 0;
                }
            }
            return maxStreak;
        }

        function getCompletionRate(activityId) {
            let completed = 0;
            for (let day = 1; day <= currentDay; day++) {
                if (isCompleted(day, activityId)) completed++;
            }
            return currentDay > 0 ? Math.round((completed / currentDay) * 100) : 0;
        }

        function startEditingActivity(activityId) {
            editingActivity = activityId;
            renderAll();
            // Focus the input after render
            setTimeout(() => {
                const input = document.querySelector(`#edit-name-${activityId}`);
                if (input) input.focus();
            }, 100);
        }

        function stopEditingActivity() {
            editingActivity = null;
            autoSaveToCloud();
            renderAll();
        }

        function updateActivityInline(activityId, field, value) {
            const activityIndex = activities.findIndex(a => a.id === activityId);
            if (activityIndex !== -1) {
                activities[activityIndex][field] = value;
                autoSaveToCloud();
                renderAll();
            }
        }

        function addActivity() {
            if (!requireAuth()) return;
            
            const name = document.getElementById('new-name').value.trim();
            if (!name) return;
            
            const newId = Math.max(...activities.map(a => a.id), 0) + 1;
            activities.push({
                id: newId,
                name,
                icon: document.getElementById('new-icon').value,
                timeOfDay: document.getElementById('new-time').value
            });
            
            document.getElementById('new-name').value = '';
            autoSaveToCloud();
            renderAll();
        }

        function deleteActivity(id) {
            if (!requireAuth()) return;
            if (!confirm('Are you sure you want to delete this activity? All progress will be lost.')) return;
            
            activities = activities.filter(a => a.id !== id);
            Object.keys(progress).forEach(day => {
                if (progress[day][id]) delete progress[day][id];
            });
            autoSaveToCloud();
            renderAll();
        }

        function moveActivity(id, direction) {
            if (!requireAuth()) return;
            const activity = activities.find(a => a.id === id);
            const sameTimeActivities = activities.filter(a => a.timeOfDay === activity.timeOfDay);
            const currentIndex = sameTimeActivities.findIndex(a => a.id === id);
            
            if (direction === 'up' && currentIndex > 0) {
                const activityIndex = activities.findIndex(a => a.id === id);
                const targetIndex = activities.findIndex(a => a.id === sameTimeActivities[currentIndex - 1].id);
                [activities[activityIndex], activities[targetIndex]] = [activities[targetIndex], activities[activityIndex]];
            } else if (direction === 'down' && currentIndex < sameTimeActivities.length - 1) {
                const activityIndex = activities.findIndex(a => a.id === id);
                const targetIndex = activities.findIndex(a => a.id === sameTimeActivities[currentIndex + 1].id);
                [activities[activityIndex], activities[targetIndex]] = [activities[targetIndex], activities[activityIndex]];
            }
            
            autoSaveToCloud();
            renderAll();
        }

        function moveToSection(id, newTimeOfDay) {
            if (!requireAuth()) return;
            const activityIndex = activities.findIndex(a => a.id === id);
            activities[activityIndex].timeOfDay = newTimeOfDay;
            autoSaveToCloud();
            renderAll();
        }

        function toggleSection(timeOfDay) {
            collapsedSections[timeOfDay] = !collapsedSections[timeOfDay];
            renderAll();
        }

        function toggleEditMode() {
            if (!requireAuth()) return;
            editMode = !editMode;
            document.getElementById('edit-btn').textContent = editMode ? '✓ Done' : '⚙️ Edit Activities';
            document.getElementById('edit-btn').className = editMode 
                ? 'px-3 py-2 bg-gray-700 text-white rounded-lg transition-colors text-sm font-medium'
                : 'px-3 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors text-sm font-medium';
            document.getElementById('edit-panel').style.display = editMode ? 'block' : 'none';
            renderAll();
        }

        // Data management
        function toggleDataManagement() {
            const panel = document.getElementById('data-panel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }

        function setDataMode(mode) {
            document.getElementById('local-options').style.display = mode === 'local' ? 'block' : 'none';
            document.getElementById('cloud-options').style.display = mode === 'cloud' ? 'block' : 'none';
            if (mode === 'cloud') {
                updateCloudUI();
            }
        }

        function exportData() {
            if (!requireAuth()) return;
            const data = { activities, progress, currentDay, exportDate: new Date().toISOString() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `habit-tracker-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            if (!requireAuth()) return;
            const file = event.target.files[0];
            if (file && file.type === 'application/json') {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        activities = data.activities || activities;
                        progress = data.progress || {};
                        currentDay = data.currentDay || 1;
                        renderAll();
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data.');
                    }
                };
                reader.readAsText(file);
            }
            event.target.value = '';
        }

        function connectCloud() {
            const url = document.getElementById('cloud-url').value.trim();
            const key = document.getElementById('cloud-key').value.trim();
            const userId = document.getElementById('cloud-user').value.trim();
            
            if (!url || !key || !userId) {
                alert('Please fill in all fields (URL, API Key, and User ID)');
                return;
            }
            
            try {
                // Initialize Supabase client
                supabase = window.supabase.createClient(url, key);
                cloudUserId = userId;
                isCloudConnected = true;
                
                // Test the connection and load existing data
                loadFromCloud().then(() => {
                    alert('Connected to Supabase successfully! Your data has been synced.');
                    renderAll();
                    toggleDataManagement(); // Close the panel
                }).catch(error => {
                    console.error('Error loading data from cloud:', error);
                    // Still mark as connected since connection works, just no data yet
                    alert('Connected to Supabase! Ready to sync your data.');
                    saveToCloud(); // Save current data as initial sync
                    toggleDataManagement();
                });
                
            } catch (error) {
                console.error('Error connecting to Supabase:', error);
                alert('Error connecting to Supabase. Please check your URL and API key.');
                isCloudConnected = false;
                supabase = null;
            }
        }

        async function saveToCloud() {
            if (!supabase || !isCloudConnected || !cloudUserId) return;
            
            try {
                // Save activities
                const { error: activitiesError } = await supabase
                    .from('habit_activities')
                    .upsert(
                        activities.map((activity, index) => ({
                            id: activity.id,
                            user_id: cloudUserId,
                            name: activity.name,
                            color: 'bg-gradient-to-r from-blue-400 to-blue-600', // default color
                            icon: activity.icon,
                            time_of_day: activity.timeOfDay,
                            order_index: index
                        }))
                    );
                
                if (activitiesError) throw activitiesError;

                // Save progress
                const progressEntries = [];
                Object.keys(progress).forEach(day => {
                    Object.keys(progress[day]).forEach(activityId => {
                        if (progress[day][activityId]) {
                            progressEntries.push({
                                user_id: cloudUserId,
                                day: parseInt(day),
                                activity_id: parseInt(activityId),
                                completed: true
                            });
                        }
                    });
                });

                if (progressEntries.length > 0) {
                    const { error: progressError } = await supabase
                        .from('habit_progress')
                        .upsert(progressEntries);
                    
                    if (progressError) throw progressError;
                }

                // Save user settings
                const { error: settingsError } = await supabase
                    .from('user_settings')
                    .upsert({
                        user_id: cloudUserId,
                        current_day: currentDay
                    });
                
                if (settingsError) throw settingsError;
                
                console.log('Data saved to cloud successfully');
                
            } catch (error) {
                console.error('Error saving to cloud:', error);
                alert('Error saving to cloud. Please check your connection.');
            }
        }

        async function loadFromCloud() {
            if (!supabase || !isCloudConnected || !cloudUserId) return;
            
            try {
                // Load activities
                const { data: activitiesData, error: activitiesError } = await supabase
                    .from('habit_activities')
                    .select('*')
                    .eq('user_id', cloudUserId)
                    .order('order_index');
                
                if (activitiesError) throw activitiesError;
                
                if (activitiesData && activitiesData.length > 0) {
                    activities = activitiesData.map(item => ({
                        id: item.id,
                        name: item.name,
                        icon: item.icon,
                        timeOfDay: item.time_of_day
                    }));
                }

                // Load progress
                const { data: progressData, error: progressError } = await supabase
                    .from('habit_progress')
                    .select('*')
                    .eq('user_id', cloudUserId);
                
                if (progressError) throw progressError;
                
                progress = {};
                if (progressData) {
                    progressData.forEach(item => {
                        if (!progress[item.day]) progress[item.day] = {};
                        progress[item.day][item.activity_id] = item.completed;
                    });
                }

                // Load settings
                const { data: settingsData, error: settingsError } = await supabase
                    .from('user_settings')
                    .select('*')
                    .eq('user_id', cloudUserId)
                    .single();
                
                if (settingsError && settingsError.code !== 'PGRST116') throw settingsError;
                
                if (settingsData) {
                    currentDay = settingsData.current_day || 1;
                }
                
            } catch (error) {
                console.error('Error loading from cloud:', error);
                throw error;
            }
        }

        // Auto-save when data changes
        function autoSaveToCloud() {
            if (isCloudConnected) {
                setTimeout(() => saveToCloud(), 1000); // Debounce saves by 1 second
            }
        }

        function disconnectCloud() {
            if (confirm('Are you sure you want to disconnect from cloud? Your local data will remain, but changes won\'t sync.')) {
                supabase = null;
                isCloudConnected = false;
                cloudUserId = null;
                updateCloudUI();
                alert('Disconnected from cloud. Your data is still available locally.');
            }
        }

        function copySupabaseSQL() {
            const sql = `-- Copy and run this SQL in your Supabase SQL Editor
-- Table for storing your activities
CREATE TABLE habit_activities (
  id bigint PRIMARY KEY,
  user_id text NOT NULL,
  name text NOT NULL,
  color text NOT NULL,
  icon text NOT NULL,
  time_of_day text NOT NULL,
  order_index integer NOT NULL,
  created_at timestamp with time zone DEFAULT now()
);

-- Table for storing your daily progress
CREATE TABLE habit_progress (
  user_id text NOT NULL,
  day integer NOT NULL,
  activity_id bigint NOT NULL,
  completed boolean NOT NULL,
  updated_at timestamp with time zone DEFAULT now(),
  PRIMARY KEY (user_id, day, activity_id)
);

-- Table for your settings
CREATE TABLE user_settings (
  user_id text PRIMARY KEY,
  current_day integer DEFAULT 1,
  updated_at timestamp with time zone DEFAULT now()
);`;

            navigator.clipboard.writeText(sql).then(() => {
                alert('SQL copied to clipboard! Paste this in your Supabase SQL Editor and run it.');
            }).catch(() => {
                // Fallback for browsers that don't support clipboard API
                const textArea = document.createElement('textarea');
                textArea.value = sql;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('SQL copied to clipboard! Paste this in your Supabase SQL Editor and run it.');
            });
        }

        function updateCloudUI() {
            const cloudStatus = document.getElementById('cloud-status');
            const cloudForm = document.getElementById('cloud-form');
            const connectBtn = document.getElementById('connect-btn');
            const disconnectBtn = document.getElementById('disconnect-btn');
            const cloudStatusText = document.getElementById('cloud-status-text');

            if (isCloudConnected) {
                cloudStatus.style.display = 'block';
                cloudForm.style.display = 'none';
                disconnectBtn.style.display = 'block';
                cloudStatusText.textContent = `🔗 Connected as ${cloudUserId}`;
            } else {
                cloudStatus.style.display = 'none';
                cloudForm.style.display = 'block';
                disconnectBtn.style.display = 'none';
            }
        }

        // Rendering functions
        function renderAll() {
            renderHeader();
            renderStats();
            renderDayGrid();
            renderActivities();
            renderEditPanel();
        }

        function renderHeader() {
            document.getElementById('demo-banner').style.display = isAuthenticated ? 'none' : 'block';
            document.getElementById('auth-buttons').style.display = isAuthenticated ? 'none' : 'flex';
            document.getElementById('user-buttons').style.display = isAuthenticated ? 'flex' : 'none';
            document.getElementById('user-welcome').style.display = isAuthenticated ? 'inline' : 'none';
            if (isAuthenticated && currentUser) {
                document.getElementById('user-welcome').textContent = `Welcome, ${currentUser.name}!`;
            }
        }

        function renderStats() {
            let totalActivities = activities.length * 40;
            let completedActivities = 0;
            let perfectDays = 0;

            for (let day = 1; day <= 40; day++) {
                let dayComplete = true;
                for (let activity of activities) {
                    if (isCompleted(day, activity.id)) {
                        completedActivities++;
                    } else {
                        dayComplete = false;
                    }
                }
                if (dayComplete && activities.length > 0) perfectDays++;
            }

            document.getElementById('overall-progress').textContent = totalActivities > 0 ? Math.round((completedActivities / totalActivities) * 100) + '%' : '0%';
            document.getElementById('current-day-stat').textContent = `${currentDay}/40`;
            document.getElementById('perfect-days').textContent = perfectDays;
        }

        function renderDayGrid() {
            const grid = document.getElementById('day-grid');
            grid.innerHTML = '';
            
            for (let day = 1; day <= 40; day++) {
                const dayProgress = activities.filter(activity => isCompleted(day, activity.id)).length;
                const totalActivities = activities.length;
                const completionRate = totalActivities > 0 ? dayProgress / totalActivities : 0;
                
                let bgColor = 'bg-gray-100';
                if (completionRate === 1) bgColor = 'bg-green-500 text-white';
                else if (completionRate > 0) bgColor = 'bg-yellow-400';
                
                const button = document.createElement('button');
                button.className = `w-10 h-10 rounded-lg font-medium text-sm transition-all card-hover ${bgColor} ${day === currentDay ? 'ring-2 ring-blue-500' : ''}`;
                button.textContent = day;
                button.onclick = () => {
                    if (requireAuth()) {
                        currentDay = day;
                        autoSaveToCloud();
                        renderAll();
                    }
                };
                grid.appendChild(button);
            }
        }

        function renderActivities() {
            document.getElementById('day-title').textContent = `Day ${currentDay} Activities`;
            
            const completed = activities.filter(activity => isCompleted(currentDay, activity.id)).length;
            document.getElementById('day-progress').textContent = `${completed} / ${activities.length} completed`;
            
            const container = document.getElementById('activities-container');
            container.innerHTML = '';
            
            timeOptions.forEach(timeOption => {
                const sectionActivities = activities.filter(a => a.timeOfDay === timeOption.value);
                const isCollapsed = collapsedSections[timeOption.value];
                
                const section = document.createElement('div');
                section.className = 'mb-6';
                
                const header = document.createElement('div');
                header.className = 'section-header rounded-lg p-4 cursor-pointer transition-colors hover:bg-gray-100 mb-3';
                header.onclick = () => toggleSection(timeOption.value);
                header.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <span class="text-2xl">${timeOption.icon}</span>
                            <h3 class="text-lg font-semibold text-gray-800">${timeOption.label}</h3>
                            <span class="text-sm text-gray-600">(${sectionActivities.length} activities)</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-600">${sectionActivities.filter(a => isCompleted(currentDay, a.id)).length} / ${sectionActivities.length} completed</span>
                            <span class="transform transition-transform ${isCollapsed ? '' : 'rotate-180'}">⌄</span>
                        </div>
                    </div>
                `;
                
                section.appendChild(header);
                
                if (!isCollapsed) {
                    const activitiesDiv = document.createElement('div');
                    activitiesDiv.className = 'space-y-3 ml-4';
                    
                    if (sectionActivities.length === 0) {
                        activitiesDiv.innerHTML = `
                            <div class="text-gray-500 text-center py-8 border-2 border-dashed border-gray-200 rounded-lg">
                                <div class="text-2xl mb-2">${timeOption.icon}</div>
                                <p class="text-sm">No ${timeOption.label.toLowerCase()} activities yet</p>
                                <p class="text-xs">Add some in edit mode!</p>
                            </div>
                        `;
                    } else {
                        sectionActivities.forEach(activity => {
                            const completed = isCompleted(currentDay, activity.id);
                            const streak = getCurrentStreak(activity.id);
                            const completionRate = getCompletionRate(activity.id);
                            const activityDiv = document.createElement('div');
                            activityDiv.className = `relative p-4 rounded-xl card-hover cursor-pointer border-2 transition-all ${completed ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-white'} ${!isAuthenticated ? 'opacity-60' : ''}`;
                            
                            // Add blur overlay for non-authenticated users
                            const overlayHtml = !isAuthenticated ? `
                                <div class="absolute inset-0 bg-white bg-opacity-50 blur-overlay rounded-xl"></div>
                            ` : '';
                            
                            // Handle inline editing or normal display
                            if (editingActivity === activity.id) {
                                activityDiv.innerHTML = `
                                    ${overlayHtml}
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-4 flex-1">
                                            <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-xl shadow-lg">
                                                <select id="edit-icon-${activity.id}" onchange="updateActivityInline(${activity.id}, 'icon', this.value)" class="bg-transparent text-white text-xl border-none outline-none cursor-pointer">
                                                    <option value="✨">✨</option>
                                                    <option value="🏃‍♂️" ${activity.icon === '🏃‍♂️' ? 'selected' : ''}>🏃‍♂️</option>
                                                    <option value="📚" ${activity.icon === '📚' ? 'selected' : ''}>📚</option>
                                                    <option value="🧘‍♀️" ${activity.icon === '🧘‍♀️' ? 'selected' : ''}>🧘‍♀️</option>
                                                    <option value="💧" ${activity.icon === '💧' ? 'selected' : ''}>💧</option>
                                                    <option value="✍️" ${activity.icon === '✍️' ? 'selected' : ''}>✍️</option>
                                                    <option value="🍎" ${activity.icon === '🍎' ? 'selected' : ''}>🍎</option>
                                                    <option value="💪" ${activity.icon === '💪' ? 'selected' : ''}>💪</option>
                                                    <option value="☀️" ${activity.icon === '☀️' ? 'selected' : ''}>☀️</option>
                                                    <option value="🌙" ${activity.icon === '🌙' ? 'selected' : ''}>🌙</option>
                                                </select>
                                            </div>
                                            <div class="flex-1">
                                                <input id="edit-name-${activity.id}" type="text" value="${activity.name}" onchange="updateActivityInline(${activity.id}, 'name', this.value)" onkeypress="if(event.key==='Enter') stopEditingActivity()" class="font-medium text-gray-800 bg-transparent border-b-2 border-blue-400 focus:outline-none focus:border-blue-600 w-full">
                                                <div class="text-xs text-blue-600 mt-1">Press Enter to save</div>
                                            </div>
                                        </div>
                                        <button onclick="stopEditingActivity()" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 text-sm">
                                            ✓ Save
                                        </button>
                                    </div>
                                `;
                            } else {
                                activityDiv.onclick = () => !editMode && toggleActivity(currentDay, activity.id);
                                activityDiv.innerHTML = `
                                    ${overlayHtml}
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center space-x-4">
                                            <div class="w-12 h-12 bg-gradient-to-r from-blue-400 to-blue-600 rounded-full flex items-center justify-center text-white text-xl shadow-lg ${editMode ? 'cursor-pointer hover:scale-105 transition-transform' : ''}" ${editMode ? `onclick="event.stopPropagation(); startEditingActivity(${activity.id})"` : ''}>
                                                ${activity.icon}
                                            </div>
                                            <div ${editMode ? `onclick="event.stopPropagation(); startEditingActivity(${activity.id})" class="cursor-pointer hover:bg-blue-50 px-2 py-1 rounded transition-colors"` : ''}>
                                                <h3 class="font-medium text-gray-800 ${editMode ? 'hover:text-blue-600' : ''}">${activity.name}</h3>
                                                ${streak > 0 ? `
                                                    <div class="flex items-center space-x-1 text-sm text-orange-600 mt-1">
                                                        <span class="text-base">🔥</span>
                                                        <span class="font-semibold">${streak} day streak!</span>
                                                    </div>
                                                ` : ''}
                                                ${completionRate > 0 ? `
                                                    <div class="text-xs text-gray-500 mt-1">${completionRate}% completion rate</div>
                                                ` : ''}
                                                ${editMode ? '<div class="text-xs text-blue-500 mt-1">Click to edit</div>' : ''}
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-3">
                                            ${completed ? 
                                                '<div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white bounce-in shadow-lg">✓</div>' :
                                                '<div class="w-8 h-8 border-2 border-gray-300 rounded-full hover:border-gray-400 transition-colors"></div>'
                                            }
                                        </div>
                                    </div>
                                `;
                            }
                            
                            activitiesDiv.appendChild(activityDiv);
                        });
                    }
                    
                    section.appendChild(activitiesDiv);
                }
                
                container.appendChild(section);
            });
            
            // Show celebration if all activities completed
            const allCompleted = activities.length > 0 && activities.every(activity => isCompleted(currentDay, activity.id));
            const celebrationDiv = document.getElementById('celebration');
            if (allCompleted && isAuthenticated) {
                celebrationDiv.style.display = 'block';
                celebrationDiv.className = 'mt-6 text-center p-6 bg-gradient-to-r from-green-400 via-blue-500 to-purple-600 rounded-xl text-white celebration shadow-2xl';
                celebrationDiv.innerHTML = `
                    <div class="text-5xl mb-3">🎉</div>
                    <h3 class="text-2xl font-bold mb-2">Day ${currentDay} Complete!</h3>
                    <p class="text-lg opacity-90">You're building amazing habits!</p>
                    <div class="mt-4 flex justify-center space-x-2">
                        <span class="text-2xl">🌟</span>
                        <span class="text-2xl">💪</span>
                        <span class="text-2xl">🚀</span>
                    </div>
                `;
            } else {
                celebrationDiv.style.display = 'none';
            }
        }

        function renderEditPanel() {
            if (!editMode) return;
            
            // Update stats with enhanced analytics
            const statsDiv = document.getElementById('activity-stats');
            const totalActivities = activities.length;
            const morningCount = activities.filter(a => a.timeOfDay === 'morning').length;
            const middayCount = activities.filter(a => a.timeOfDay === 'midday').length;
            const eveningCount = activities.filter(a => a.timeOfDay === 'evening').length;
            
            // Calculate overall completion rate
            let totalPossible = 0;
            let totalCompleted = 0;
            activities.forEach(activity => {
                for (let day = 1; day <= currentDay; day++) {
                    totalPossible++;
                    if (isCompleted(day, activity.id)) totalCompleted++;
                }
            });
            const overallRate = totalPossible > 0 ? Math.round((totalCompleted / totalPossible) * 100) : 0;
            
            statsDiv.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-2 bg-purple-50 rounded">
                        <span class="text-gray-700 font-medium">Total Activities:</span>
                        <span class="font-bold text-purple-600">${totalActivities}</span>
                    </div>
                    <div class="grid grid-cols-3 gap-1 text-xs">
                        <div class="text-center p-2 bg-orange-50 rounded">
                            <div class="font-semibold text-orange-600">${morningCount}</div>
                            <div class="text-orange-500">🌅 Morning</div>
                        </div>
                        <div class="text-center p-2 bg-yellow-50 rounded">
                            <div class="font-semibold text-yellow-600">${middayCount}</div>
                            <div class="text-yellow-500">☀️ Mid-day</div>
                        </div>
                        <div class="text-center p-2 bg-indigo-50 rounded">
                            <div class="font-semibold text-indigo-600">${eveningCount}</div>
                            <div class="text-indigo-500">🌙 Evening</div>
                        </div>
                    </div>
                    <div class="flex justify-between items-center p-2 bg-green-50 rounded">
                        <span class="text-gray-700 font-medium">Overall Rate:</span>
                        <span class="font-bold text-green-600">${overallRate}%</span>
                    </div>
                </div>
            `;
            
            // Update activities list with enhanced management
            const listDiv = document.getElementById('edit-activities-list');
            listDiv.innerHTML = '';
            
            timeOptions.forEach(timeOption => {
                const sectionActivities = activities.filter(a => a.timeOfDay === timeOption.value);
                
                const timeDiv = document.createElement('div');
                timeDiv.className = 'mb-6';
                timeDiv.innerHTML = `
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-200">
                        <div class="flex items-center space-x-2">
                            <span class="text-lg">${timeOption.icon}</span>
                            <h4 class="font-semibold text-gray-700">${timeOption.label}</h4>
                        </div>
                        <div class="flex items-center space-x-2">
                            <span class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded font-medium">${sectionActivities.length} activities</span>
                            ${sectionActivities.length > 0 ? `<span class="text-xs text-green-600 bg-green-100 px-2 py-1 rounded font-medium">${Math.round((sectionActivities.reduce((sum, a) => sum + getCompletionRate(a.id), 0) / sectionActivities.length) || 0)}% avg</span>` : ''}
                        </div>
                    </div>
                `;
                
                const activitiesContainer = document.createElement('div');
                activitiesContainer.className = 'space-y-2';
                
                if (sectionActivities.length === 0) {
                    activitiesContainer.innerHTML = `
                        <div class="text-center py-8 text-gray-400 border-2 border-dashed border-gray-200 rounded-lg">
                            <div class="text-2xl mb-2">${timeOption.icon}</div>
                            <p class="text-sm">No ${timeOption.label.toLowerCase()} activities</p>
                            <p class="text-xs">Add activities using the form on the left</p>
                        </div>
                    `;
                } else {
                    sectionActivities.forEach((activity, index) => {
                        const streak = getCurrentStreak(activity.id);
                        const longestStreak = getLongestStreak(activity.id);
                        const completionRate = getCompletionRate(activity.id);
                        
                        const activityDiv = document.createElement('div');
                        activityDiv.className = 'p-3 bg-white border border-gray-200 rounded-lg hover:border-gray-300 shadow-sm hover:shadow transition-all';
                        activityDiv.innerHTML = `
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3 flex-1">
                                    <span class="text-xl">${activity.icon}</span>
                                    <div class="flex-1">
                                        <span class="font-medium text-gray-800">${activity.name}</span>
                                        <div class="flex items-center space-x-3 mt-1">
                                            ${streak > 0 ? `<span class="text-xs text-orange-600 bg-orange-50 px-2 py-1 rounded flex items-center space-x-1"><span>🔥</span><span>${streak}</span></span>` : ''}
                                            ${longestStreak > 0 ? `<span class="text-xs text-purple-600 bg-purple-50 px-2 py-1 rounded">Best: ${longestStreak}</span>` : ''}
                                            ${completionRate > 0 ? `<span class="text-xs text-blue-600 bg-blue-50 px-2 py-1 rounded">${completionRate}%</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-1">
                                    ${timeOptions.filter(t => t.value !== activity.timeOfDay).map(t => 
                                        `<button onclick="moveToSection(${activity.id}, '${t.value}')" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded transition-colors" title="Move to ${t.label}">${t.icon}</button>`
                                    ).join('')}
                                    <div class="border-l border-gray-200 pl-2 ml-2 flex space-x-1">
                                        <button onclick="moveActivity(${activity.id}, 'up')" ${index === 0 ? 'disabled' : ''} class="p-1.5 text-gray-400 hover:text-gray-600 disabled:opacity-30 hover:bg-gray-50 rounded transition-colors" title="Move up">⬆️</button>
                                        <button onclick="moveActivity(${activity.id}, 'down')" ${index === sectionActivities.length - 1 ? 'disabled' : ''} class="p-1.5 text-gray-400 hover:text-gray-600 disabled:opacity-30 hover:bg-gray-50 rounded transition-colors" title="Move down">⬇️</button>
                                        <button onclick="startEditingActivity(${activity.id})" class="p-1.5 text-blue-500 hover:bg-blue-50 rounded transition-colors" title="Edit details">✏️</button>
                                        <button onclick="deleteActivity(${activity.id})" class="p-1.5 text-red-500 hover:bg-red-50 rounded transition-colors" title="Delete activity">❌</button>
                                    </div>
                                </div>
                            </div>
                        `;
                        activitiesContainer.appendChild(activityDiv);
                    });
                }
                
                timeDiv.appendChild(activitiesContainer);
                listDiv.appendChild(timeDiv);
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('#data-panel') && !e.target.closest('[onclick*="toggleDataManagement"]')) {
                document.getElementById('data-panel').style.display = 'none';
            }
        });
    </script>
</body>
</html>
